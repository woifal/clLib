<!DOCTYPE html> 
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<title>clLib Test</title> 
<!--	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.css" />-->
		<link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />
		<link rel="stylesheet" href="css/clRouteColors.css" />

	
		<script type="text/javascript" src="js/clLib.js"></script>
		<script type="text/javascript" src="js/clLib.gradeConfig.js"></script>
		<script type="text/javascript" src="js/clLib.localStorage.js"></script>
		<script type="text/javascript" src="js/clLib.localStorage.indexes.js"></script>
		<script type="text/javascript" src="js/clLib.UI.js"></script>
		<script type="text/javascript" src="js/clLib.REST.js"></script>

		
		
		
		<script type="text/javascript" src="sampledata/routeLogSample.js"></script>
		<script type="text/javascript" src="sampledata/routeSample_big.js"></script>
		
<!--
		<script type="text/javascript" src="http://codeorigin.jquery.com/jquery-1.8.2.js"></script>
        <script type="text/javascript" src="http://codeorigin.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.js"></script>
-->
		<script type="text/javascript" src="js/jquery-1.8.2.js"></script>
        <script type="text/javascript" src="js/jquery.mobile-1.3.0.js"></script>


</head> 

<body> 

<div data-role="page">

	<div data-role="header">
		<h1>Single page</h1>
	</div><!-- /header -->

	<div data-role="content">	

	
		<p>
			<select id="whereSamples">
				<option value='{"Name" : {"$like": "auber" }}'>{"Name" : { "$like": "auber" }}</option>
				<option value='{"French":"6a+","Area":"Climb on Marswiese","Sector":"Turm-C"}'>{"French":"6a+","Area":"Climb on Marswiese","Sector":"Turm-C"}</option>
			</select>
		</p>
		<p>
			<input style="width: 300px" id="whereClauseStr" value=""/>
		</p>
		<p>
			<input style="width: 200px" id="distinctColumn" value=""/>
		</p>
		<p>
			<input id="testQuery" type="button">
		</p>	
			<div id="foo">.....</div>

		<button id="top5Button">show top5</button>
		<ul 
			data-role="listview" id="top5" 
			data-inset="true" 
		>
			<li>
				<a>
					asdflaksdflkasjdf
				</a>
			</li>
		</ul>

		<ul 
			data-role="listview" id="top5simple" 
			data-inset="true" 
		>
			<li>
				<a>
					asdflaksdflkasjdf
				</a>
			</li>
		</ul>

<div id="top5Div"
<div data-role="collapsible" data-theme="b" data-content-theme="d" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d" data-inset="false">
							<h2>Pets</h2>
							<ul data-role="listview">
								<li><a href="index.html">Canary</a></li>
								<li><a href="index.html">Cat</a></li>
								<li><a href="index.html">Dog</a></li>
								<li><a href="index.html">Gerbil</a></li>
								<li><a href="index.html">Iguana</a></li>
								<li><a href="index.html">Mouse</a></li>
							</ul>
						</div><!-- /collapsible -->
</div>
	</div><!-- /content -->
	
	<div data-role="footer">
		<h4>Footer content</h4>
	</div><!-- /footer -->
	
</div><!-- /page -->
<script>
	"use strict";
	
	
	
(function(){
//$( document ).live("mobileinit", function() {
   console.log("start");
	
	// set current user...
	localStorage.setItem("currentUser", "gere");

	// get routelog for current user..
	var userRouteLogs = clLib.REST.getEntities("RouteLog", {});

	// initialize storage for current user's routelogs
	clLib.localStorage.initStorage("routeLogStorage", userRouteLogs);

	// build where clause for today's routelogs
	var where = clLib.getRouteLogWhereToday(clLib.getCurrentUserWhere());
	//alert("ZZZ" + JSON.stringify(where));

	// retrieve today's routelogs
	//var todaysRouteLogs = clLib.localStorage.getEntities("RouteLog", where, "routeLogStorage");
	//alert("items retrieved " + JSON.stringify(todaysRouteLogs));

	// retrieve today's routelogs (sorted by Date)
	var todaysRouteLogs = clLib.localStorage.getEntities("RouteLog", where, "routeLogStorage", "Date", true, 10);
	//alert("items retrieved(latest first) " + JSON.stringify(todaysRouteLogs));

	
	// Get number of today's routes
	var todaysRouteLogCount = JSON.stringify(todaysRouteLogs.length);
	//alert("items count" + todaysRouteLogCount);


	// retrieve today's 2 top scored routelogs
	var todaysTopRouteLogs = clLib.localStorage.getEntities("RouteLog", where, "routeLogStorage", 
		clLib.sortByScoreFunc,
		true, 10);
	//alert("items retrieved(high-scored first) " + JSON.stringify(todaysTopRouteLogs));
	//alert("items retrieved(latest first) " + JSON.stringify(todaysRouteLogs));

	// calculate today's score
	var todaysTopScore = clLib.calculateScore(todaysTopRouteLogs);
	var todaysScore = clLib.calculateScore(todaysRouteLogs);
	alert("todays score(latest10)" + todaysScore);
	alert("todays score(top10)" + todaysTopScore);

	
	// build where clause for today's routelogs
	var buddyWhere = clLib.getRouteLogWhereToday({userName: "edgar"});
	// retrieve today's top scored routelogs
	var buddyTodaysTopRouteLogs = clLib.localStorage.getEntities("RouteLog", buddyWhere, "routeLogStorage", 
		clLib.sortByScoreFunc,
		true, 10);
	// calculate today's score
	var buddyTodaysTopScore = clLib.calculateScore(buddyTodaysTopRouteLogs);
	alert("buddys todays score(top10)" + buddyTodaysTopScore);
	




	$("#top5Button").click(function() {
		//clLib.populateListViewCollapsible($("#top5Div"), todaysRouteLogs, "RouteName");

		/*
			Show 5 latest routes.
		*/
		clLib.populateListView($("#top5"), todaysRouteLogs, function(itemObj) { 
			return itemObj["RouteName"] + "(@" + itemObj["Date"].substring(11,19) + ")" + "=> score" + clLib.computeScore(itemObj);
		});

		clLib.populateListView($("#top5simple"), ["aaaaa", "bbbbb"]);

	});
	
	return;

$.mobile.loader( 'show', {
text: "as",
textVisible: true,
theme: "Asdf",
textonly: false,
html: "asdf"
});


	var profiledFnCall = function(iterations, aFunc) {
		var totalDuration = 0;
		for(var i = 0; i < iterations; i++) {
			var startDate = +new Date();
			aFunc();
			var endDate = +new Date();
			totalDuration += (endDate - startDate);
		}
		return totalDuration / iterations;
	};
	
	//alert(JSON.stringify(routeLogSample));
	clLib.localStorage.initStorage("routeLogStorage", routeLogSample);
	
	var where = clLib.getRouteLogWhereToday();
	alert("ZZZ" + JSON.stringify(where));
	var todaysRouteLogs = clLib.localStorage.getEntities("routeLogs", where, "routeLogStorage");

	alert("YYY" + JSON.stringify(todaysRouteLogs));
	alert("XXX" + clLib.calculateScore(todaysRouteLogs));
	
	//console.profile();
	console.log("init storage start");
	alert(profiledFnCall(1, function() { clLib.localStorage.initStorage("routeLogStorage", routeSample); }));
	console.log("init storage end");
	//console.profileEnd();
	
	var distinctColumn, where = 
			clLib.getRoutesWhere("French", "6a+", "Climb on Marswiese", "Turm-C");
	var whereStr = '{"Name" : { "$like": "auber" }}';
	$("#whereClauseStr").val(whereStr);
	$("#distinctColumn").val("Colour");
	$("#whereSamples").change(function() {
		$("#whereClauseStr").val($(this).val());
	});
	
	//alert("built where clause " + tojson(JSON.parse(whereStr)));
	$("#testQuery").click(function() {
		var whereObj = JSON.parse($("#whereClauseStr").val());
		distinctColumn = $("#distinctColumn").val();
		var results = {}, distincts = {};
		
		var avgDur = profiledFnCall(10, function() { 
			distincts = clLib.localStorage.getDistinct("routes", whereObj, distinctColumn, "routeLogStorage");
		});
		printi("avg duration for distincts: " + avgDur);
		
		var avgDur = profiledFnCall(10, function() { 
			results = clLib.localStorage.getEntities("routes", whereObj, "routeLogStorage");
		});
		printi("avg duration for results: " + avgDur);
			printi("got no of results:" + Object.keys(results).length);
			printi("got no of distinct Colours:" + Object.keys(distincts).length);
			printi("got distinct Colours:" + JSON.stringify(distincts.sort()));
			//alert(Object.keys(results).length);
	});
	
	var printi = function(text) {
		$("<p>").html(text).appendTo("#foo");
	
	};
	
	alert("today >" + clLib.today());
	alert("tomorrow >" + clLib.tomorrow());
	alert("datebetween : " + JSON.stringify(clLib.colBetweenDate("someDate", new Date(Date.parse("09/18/2013")), new Date(Date.parse("09/20/2013")))));
	alert("datebetween : " + JSON.stringify(clLib.colBetweenDate("someDate", clLib.today(), clLib.tomorrow())));
	

	console.log("end");
})(jQuery);
//});		

   </script>
	
</body>

  
</html>